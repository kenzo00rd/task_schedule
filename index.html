<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAKUGO Planner Pro - ãƒˆãƒƒãƒ—å…¥åŠ›å¯¾å¿œç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSSã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š --- */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .hidden { display: none; }
        
        /* ã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .tab-active { background-color: white; color: #4f46e5; font-weight: bold; border-bottom: 2px solid #4f46e5; }
        .tab-inactive { background-color: transparent; color: #e0e7ff; }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 90px; background: white; border: 1px solid #e5e7eb; padding: 4px; font-size: 0.8rem; position: relative;}
        .calendar-day:hover { border-color: #6366f1; background-color: #f5f3ff; }
        .today { background-color: #eff6ff; border-color: #93c5fd; }

        /* å„ªå…ˆåº¦ãƒãƒƒã‚¸ */
        .prio-high { border-left: 4px solid #ef4444; background-color: #fef2f2; }
        .prio-mid { border-left: 4px solid #3b82f6; background-color: #eff6ff; }
        .prio-low { border-left: 4px solid #9ca3af; background-color: #f9fafb; }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-container { position: relative; height: 600px; border-left: 1px solid #d1d5db; background: repeating-linear-gradient(0deg, #f9fafb, #f9fafb 24px, #e5e7eb 25px); background-size: 100% 25px; }
        .timeline-hour { position: absolute; left: -35px; font-size: 10px; color: #6b7280; height: 25px; line-height: 25px; }
        .time-block { position: absolute; left: 2px; right: 2px; border-radius: 4px; font-size: 10px; padding: 2px; overflow: hidden; color: white; opacity: 0.9; box-shadow: 1px 1px 2px rgba(0,0,0,0.1); transition: all 0.2s; z-index: 10; cursor: pointer; }
        .time-block:hover { z-index: 20; transform: scale(1.02); opacity: 1; }
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .task-item:hover .delete-btn { opacity: 1; }
        .delete-btn { opacity: 0.3; transition: opacity 0.2s; }

        /* ã‚„ã‚‰ãªã„ã“ã¨ãƒªã‚¹ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes bounce-sm {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .streak-fire { color: #f97316; animation: bounce-sm 1s infinite; }
    </style>
</head>
<body>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-40">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved"></i> KAKUGO Planner Pro
                </h1>
                <p class="text-xs text-indigo-200">è¦šæ‚Ÿã®ã‚¿ã‚¹ã‚¯ç®¡ç†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ç‰ˆï¼‰</p>
            </div>
            <div class="flex bg-indigo-800 rounded-full p-1">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="px-4 py-1 rounded-full text-sm transition tab-active">ä»Šæ—¥</button>
                <button onclick="switchTab('planning')" id="btn-planning" class="px-4 py-1 rounded-full text-sm transition tab-inactive">ã‚«ãƒ†ã‚´ãƒªç·¨é›†</button>
                <button onclick="switchTab('calendar')" id="btn-calendar" class="px-4 py-1 rounded-full text-sm transition tab-inactive">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 pb-20">
        
        <!-- 1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆä»Šæ—¥ã®ãƒªã‚¹ãƒˆ å…¼ å…¥åŠ›ç”»é¢ï¼‰ -->
        <div id="view-dashboard" class="block space-y-6">
            
            <!-- â˜…ã“ã“ã«è¿½åŠ ï¼šãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ã®äºˆå®šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="bg-white p-4 rounded-lg shadow-lg border-t-4 border-indigo-600">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-pen-to-square text-indigo-500"></i> æ–°ã—ã„äºˆå®šã‚’è¿½åŠ 
                </h3>
                <div class="flex flex-col md:flex-row gap-2 items-end md:items-center">
                    <!-- ã‚¿ã‚¹ã‚¯å -->
                    <input type="text" id="quick-task-title" placeholder="ã‚¿ã‚¹ã‚¯å (ä¾‹: ä¼šè­°ã€è²·ã„ç‰©)" 
                           class="w-full md:flex-1 border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-200 outline-none">
                    
                    <!-- æ—¥ä»˜ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»Šæ—¥) -->
                    <input type="date" id="quick-task-date" class="w-full md:w-auto border border-gray-300 p-2 rounded text-gray-600">
                    
                    <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
                    <select id="quick-task-goal" class="w-full md:w-auto border border-gray-300 p-2 rounded bg-white text-gray-600">
                        <!-- JSã§è‡ªå‹•ç”Ÿæˆ -->
                    </select>

                    <!-- è¿½åŠ ãƒœã‚¿ãƒ³ -->
                    <button onclick="addQuickTask()" class="w-full md:w-auto bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700 transition shadow">
                        è¿½åŠ 
                    </button>
                </div>
            </div>

            <!-- â›” ã‚„ã‚‰ãªã„ã“ã¨ãƒªã‚¹ãƒˆ -->
            <div class="bg-red-50 border-2 border-red-200 rounded-lg shadow-sm p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-red-700 flex items-center gap-2">
                        <i class="fa-solid fa-ban"></i> ã‚„ã‚‰ãªã„ã“ã¨ãƒªã‚¹ãƒˆ (NOT TO DO)
                    </h3>
                    <button onclick="document.getElementById('add-not-todo-form').classList.toggle('hidden')" class="text-xs text-red-500 hover:bg-red-100 px-2 py-1 rounded">
                        <i class="fa-solid fa-plus"></i> è¿½åŠ 
                    </button>
                </div>
                
                <div id="add-not-todo-form" class="hidden mb-3 flex gap-2">
                    <input type="text" id="new-not-todo" placeholder="ä¾‹ï¼šã‚³ãƒ³ãƒ“ãƒ‹ã«å¯„ã‚‰ãªã„ã€ã‚®ãƒ£ãƒ³ãƒ–ãƒ«..." class="flex-1 text-sm border p-2 rounded outline-none focus:border-red-400">
                    <button onclick="addNotToDo()" class="bg-red-500 text-white px-4 py-1 rounded text-sm font-bold">ç™»éŒ²</button>
                </div>

                <div id="not-todo-list" class="space-y-2"></div>
            </div>

            <!-- æ‰‹å‹•LINEå…±æœ‰ã‚¨ãƒªã‚¢ -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg shadow-lg p-4 text-white flex justify-between items-center">
                <div>
                    <h3 class="font-bold"><i class="fa-brands fa-line text-xl mr-2"></i>ä»Šæ—¥ã®äºˆå®šã‚’LINEã«é€ã‚‹</h3>
                    <p class="text-xs opacity-90">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨LINEãŒèµ·å‹•ã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™</p>
                </div>
                <button onclick="sendScheduleToLine()" class="bg-white text-green-600 px-4 py-2 rounded-full font-bold shadow hover:bg-gray-100 transition transform hover:scale-105">
                    LINEèµ·å‹• <i class="fa-solid fa-paper-plane ml-1"></i>
                </button>
            </div>

            <!-- ä»Šæ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ -->
            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800"><span class="text-indigo-600" id="today-date-display"></span> ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
                    <div class="flex gap-2">
                        <button onclick="requestNotificationPermission()" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded hover:bg-gray-200" title="ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ã„ã¦ã„ã‚‹é–“ã®ã¿é€šçŸ¥">
                            <i class="fa-solid fa-bell"></i> é€šçŸ¥ON
                        </button>
                        <button onclick="openDailyDetail(new Date())" class="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-200">
                            <i class="fa-solid fa-clock"></i> æ™‚é–“å‰²
                        </button>
                    </div>
                </div>
                <div id="today-task-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- 2. è¨ˆç”»ãƒ»ç´°åˆ†åŒ–ï¼ˆã‚«ãƒ†ã‚´ãƒªç·¨é›†ï¼‰ -->
        <div id="view-planning" class="hidden space-y-6">
            <div class="bg-indigo-50 p-6 rounded-lg border border-indigo-100 shadow-inner">
                <label class="block text-sm font-bold text-indigo-900 mb-2">â‘  ã‚«ãƒ†ã‚´ãƒªï¼ˆç›®æ¨™ï¼‰ã‚’è¿½åŠ ã™ã‚‹</label>
                <div class="flex gap-2">
                    <input type="text" id="new-goal-title" placeholder="ä¾‹ï¼šä»•äº‹ã€è³‡æ ¼å‹‰å¼·ã€è²·ã„ç‰©ãƒªã‚¹ãƒˆ..." class="flex-1 p-3 border border-indigo-200 rounded shadow-sm">
                    <button onclick="addGoal()" class="bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700 shadow">ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
                </div>
            </div>
            <div id="goals-container" class="space-y-6"></div>
        </div>

        <!-- 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div id="view-calendar" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-4">
                        <button onclick="changeMonth(-1)" class="text-gray-500 hover:text-indigo-600"><i class="fa-solid fa-chevron-left"></i></button>
                        <h2 class="text-xl font-bold text-gray-800" id="calendar-month-display"></h2>
                        <button onclick="changeMonth(1)" class="text-gray-500 hover:text-indigo-600"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="calendar-grid text-center font-bold text-gray-500 text-xs pb-2">
                    <div class="text-red-400">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div class="text-blue-400">åœŸ</div>
                </div>
                <div id="calendar-cells" class="calendar-grid mt-1"></div>
            </div>
        </div>
    </main>

    <!-- 1æ—¥ã®è©³ç´°ãƒ»ã‚¿ã‚¤ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-daily" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex justify-center items-start pt-10">
        <div class="bg-white w-full max-w-4xl rounded-lg shadow-2xl overflow-hidden mb-10">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold" id="daily-modal-date"></h3>
                <button onclick="closeDailyModal()" class="text-indigo-200 hover:text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex flex-col md:flex-row h-[700px]">
                <div class="w-full md:w-1/3 border-r bg-gray-50 p-4 overflow-y-auto">
                    <h4 class="font-bold text-gray-700 mb-2 text-center text-sm">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (6:00 - 24:00)</h4>
                    <div class="relative mt-4 pl-8 pr-2">
                        <div id="timeline-view" class="timeline-container"></div>
                    </div>
                </div>
                <div class="w-full md:w-2/3 p-4 overflow-y-auto bg-white">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h4 class="font-bold text-gray-700">ã‚¿ã‚¹ã‚¯ã®ç·¨é›†</h4>
                    </div>
                    <div id="daily-task-editor" class="space-y-4"></div>
                    <div id="daily-empty-msg" class="text-center text-gray-400 py-10 hidden">
                        ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªå‹•ææ¡ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-suggest" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex justify-center items-center">
        <div class="bg-white w-full max-w-md p-5 rounded-lg shadow-lg">
            <h3 class="font-bold text-lg mb-2 text-indigo-700">è‡ªå‹•ææ¡ˆãƒªã‚¹ãƒˆ</h3>
            <div id="suggest-list" class="max-h-60 overflow-y-auto border p-2 mb-4 bg-gray-50 rounded"></div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('modal-suggest').classList.add('hidden')" class="px-3 py-1 bg-gray-200 rounded">é–‰ã˜ã‚‹</button>
                <button onclick="importSuggestedTasks()" class="px-3 py-1 bg-indigo-600 text-white rounded font-bold">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <script>
        /* --- JavaScript ãƒ—ãƒ­ã‚°ãƒ©ãƒ  --- */

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        const STORAGE_KEY = 'kakugo_planner_pro_local';
        const STORAGE_NOT_TODO = 'kakugo_not_todo_local';

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½œæˆï¼‰
        let goals = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        if (goals.length === 0) {
            goals = [{ id: 1, title: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†', tasks: [] }];
        }
        
        let notToDos = JSON.parse(localStorage.getItem(STORAGE_NOT_TODO)) || [];

        let currentGoalId = null;
        let selectedDateStr = null; 
        let currentCalendarDate = new Date();

        // ææ¡ˆãƒ‡ãƒ¼ã‚¿
        const SUGGESTIONS = {
            'ãƒ–ãƒ­ã‚°': ['ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é¸å®š', 'æ§‹æˆæ¡ˆä½œæˆ', 'è¨˜äº‹åŸ·ç­†(2000å­—)', 'ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒä½œæˆ', 'SNSã‚·ã‚§ã‚¢'],
            'ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ': ['ä½“é‡è¨˜éŒ²', 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ30å›', 'é£Ÿäº‹å†™çœŸã‚’æ’®ã‚‹', 'ãŠè“å­ã‚’æˆ‘æ…¢ã™ã‚‹', 'ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°20åˆ†'],
            'å‹‰å¼·': ['å˜èªå¸³10åˆ†', 'å•é¡Œé›†2ãƒšãƒ¼ã‚¸', 'å¾©ç¿’', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¬›ç¾©è¦–è´'],
            'ä»•äº‹': ['ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯', 'ä¼šè­°è³‡æ–™ä½œæˆ', 'æ—¥å ±æå‡º', 'æ˜æ—¥ã®äºˆå®šç¢ºèª'],
            'default': ['ç¾çŠ¶ã®ãƒªã‚µãƒ¼ãƒ', 'å¿…è¦ãªé“å…·ã®æº–å‚™', 'æœŸé™ã®è¨­å®š', 'å‚è€ƒæ›¸ã‚’èª­ã‚€', '5åˆ†ã ã‘ç€æ‰‹ã™ã‚‹']
        };

        // èµ·å‹•æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            updateDateDisplay();
            // å…¥åŠ›æ¬„ã®æ—¥ä»˜ã‚’ä»Šæ—¥ã«ã™ã‚‹
            document.getElementById('quick-task-date').value = new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'}).replaceAll('/','-');
            
            renderAll();
            renderNotToDoList();
            checkNotifications();
        });

        function updateDateDisplay() {
            const today = new Date();
            const ops = {year:'numeric', month:'short', day:'numeric', weekday:'short'};
            document.getElementById('today-date-display').innerText = today.toLocaleDateString('ja-JP', ops);
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(goals));
            localStorage.setItem(STORAGE_NOT_TODO, JSON.stringify(notToDos));
            renderAll();
            renderNotToDoList();
            if(!document.getElementById('modal-daily').classList.contains('hidden')){
                renderDailyContent(selectedDateStr);
            }
        }

        // --- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ  ---
        function addQuickTask() {
            const titleInput = document.getElementById('quick-task-title');
            const dateInput = document.getElementById('quick-task-date');
            const goalSelect = document.getElementById('quick-task-goal');

            const title = titleInput.value.trim();
            const date = dateInput.value;
            const goalId = parseInt(goalSelect.value);

            if(!title) { alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if(!date) { alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            if(!goalId) { alert('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

            // æŒ‡å®šã•ã‚ŒãŸã‚´ãƒ¼ãƒ«(ã‚«ãƒ†ã‚´ãƒª)ã‚’æ¢ã™
            const goal = goals.find(g => g.id === goalId);
            if(goal) {
                goal.tasks.push({
                    id: Date.now(),
                    title: title,
                    date: date,
                    priority: 'mid',
                    startTime: '',
                    duration: 30,
                    completed: false
                });
                titleInput.value = ''; // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                saveData();
            }
        }

        // --- ã‚„ã‚‰ãªã„ã“ã¨ãƒªã‚¹ãƒˆ (NOT TO DO) ---
        function addNotToDo() {
            const input = document.getElementById('new-not-todo');
            const title = input.value.trim();
            if(!title) return;

            notToDos.push({ id: Date.now(), title: title, lastCheckedDate: null, streak: 0 });
            input.value = '';
            document.getElementById('add-not-todo-form').classList.add('hidden');
            saveData();
        }

        function deleteNotToDo(id) {
            if(confirm('å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                notToDos = notToDos.filter(item => item.id !== id);
                saveData();
            }
        }

        function toggleNotToDo(id) {
            const item = notToDos.find(i => i.id === id);
            const todayStr = new Date().toLocaleDateString('ja-JP').replaceAll('/','-');
            
            if(item.lastCheckedDate === todayStr) {
                if(confirm('ä»Šæ—¥ã®é”æˆã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    item.lastCheckedDate = null; 
                    if(item.streak > 0) item.streak--;
                }
            } else {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toLocaleDateString('ja-JP').replaceAll('/','-');

                if (item.lastCheckedDate === yesterdayStr) item.streak++;
                else item.streak = 1;
                
                item.lastCheckedDate = todayStr;
                alert(`ç´ æ™´ã‚‰ã—ã„ï¼ã€Œ${item.title}ã€ã‚’æˆ‘æ…¢ã—ã¾ã—ãŸã€‚\nç¾åœ¨ ${item.streak}æ—¥ é€£ç¶šé”æˆä¸­ï¼ğŸ”¥`);
            }
            saveData();
        }

        function renderNotToDoList() {
            const list = document.getElementById('not-todo-list');
            list.innerHTML = '';
            const todayStr = new Date().toLocaleDateString('ja-JP').replaceAll('/','-');

            if(notToDos.length === 0) {
                list.innerHTML = '<div class="text-xs text-red-400 text-center">ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¾ã—ã‚‡ã†ã€‚</div>';
                return;
            }

            notToDos.forEach(item => {
                const isDoneToday = item.lastCheckedDate === todayStr;
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-3 rounded border ${isDoneToday ? 'bg-red-100 border-red-300' : 'bg-white border-red-100'}`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-1">
                        <button onclick="toggleNotToDo(${item.id})" class="text-xl w-8 h-8 rounded-full flex justify-center items-center transition ${isDoneToday ? 'bg-red-500 text-white shadow-lg scale-110' : 'bg-gray-100 text-gray-300 hover:bg-red-100 hover:text-red-300'}">
                            <i class="fa-solid fa-shield-cat"></i>
                        </button>
                        <div>
                            <div class="font-bold text-gray-800 ${isDoneToday ? 'text-red-800' : ''}">${item.title}</div>
                            <div class="text-xs text-gray-500 flex items-center gap-1">
                                ${isDoneToday ? '<span class="text-red-600 font-bold">ä»Šæ—¥ã‚‚é”æˆï¼</span>' : 'ä»Šæ—¥ã¯ã¾ã æœªé”æˆ'}
                                <span class="bg-gray-100 px-1 rounded ml-1">ğŸ”¥ é€£ç¶š ${item.streak}æ—¥</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="deleteNotToDo(${item.id})" class="text-gray-300 hover:text-red-400 ml-2"><i class="fa-solid fa-trash-can"></i></button>
                `;
                list.appendChild(div);
            });
        }

        // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
        function switchTab(tab) {
            ['dashboard', 'planning', 'calendar'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`btn-${t}`).classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`btn-${tab}`).classList.replace('tab-inactive', 'tab-active');
            if(tab === 'calendar') renderCalendar();
        }

        // --- ã‚´ãƒ¼ãƒ«æ“ä½œ ---
        function addGoal() {
            const title = document.getElementById('new-goal-title').value.trim();
            if(!title) return;
            goals.push({ id: Date.now(), title: title, tasks: [] });
            document.getElementById('new-goal-title').value = '';
            saveData();
        }

        function deleteGoal(id) {
            if(confirm('ã€è­¦å‘Šã€‘ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã“ã«å«ã¾ã‚Œã‚‹ã€Œã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã€ã‚‚ä¸€ç·’ã«æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚\nå€‹åˆ¥ã®ã‚¿ã‚¹ã‚¯ã‚’æ¶ˆã—ãŸã„å ´åˆã¯ã€å„ã‚¿ã‚¹ã‚¯ã®ã‚´ãƒŸç®±ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚')) {
                goals = goals.filter(g => g.id !== id);
                saveData();
            }
        }

        // --- ã‚¿ã‚¹ã‚¯æ“ä½œ ---
        function addTask(goalId, title=null, date=null, priority='mid') {
            const tTitle = title || document.getElementById(`title-${goalId}`).value;
            const tDate = date || document.getElementById(`date-${goalId}`).value;
            const tPrio = document.getElementById(`prio-${goalId}`)?.value || priority;
            
            if(!tTitle || !tDate) return;

            const goal = goals.find(g => g.id === goalId);
            if(goal) {
                goal.tasks.push({
                    id: Date.now(), title: tTitle, date: tDate, priority: tPrio, startTime: '', duration: 30, completed: false
                });
                saveData();
                if(!title && document.getElementById(`title-${goalId}`)) {
                    document.getElementById(`title-${goalId}`).value = '';
                }
            }
        }
        
        function deleteTask(goalId, taskId) {
            if(confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const goal = goals.find(g => g.id === goalId);
                if(goal) {
                    goal.tasks = goal.tasks.filter(t => t.id !== taskId);
                    saveData();
                }
            }
        }

        function toggleTask(goalId, taskId) {
            const goal = goals.find(g => g.id === goalId);
            const task = goal.tasks.find(t => t.id === taskId);
            if(task) {
                task.completed = !task.completed;
                saveData();
            }
        }

        function updateTaskDetails(goalId, taskId, field, value) {
            const goal = goals.find(g => g.id === goalId);
            const task = goal.tasks.find(t => t.id === taskId);
            if(task) {
                task[field] = value;
                saveData();
            }
        }

        // --- è©³ç´° & ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ ---
        function openDailyDetail(dateObj) {
            selectedDateStr = dateObj.toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'}).replaceAll('/', '-');
            const dayOfWeek = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dateObj.getDay()];
            document.getElementById('daily-modal-date').innerText = `${selectedDateStr} (${dayOfWeek})`;
            document.getElementById('modal-daily').classList.remove('hidden');
            renderDailyContent(selectedDateStr);
        }

        function closeDailyModal() {
            document.getElementById('modal-daily').classList.add('hidden');
            renderCalendar(); renderAll();
        }

        function renderDailyContent(dateStr) {
            const container = document.getElementById('daily-task-editor');
            const timeline = document.getElementById('timeline-view');
            container.innerHTML = ''; timeline.innerHTML = '';

            for(let i=6; i<=24; i++) {
                const hourDiv = document.createElement('div');
                hourDiv.className = 'timeline-hour';
                hourDiv.style.top = `${(i - 6) * 25}px`; 
                hourDiv.innerText = `${i}:00`;
                timeline.appendChild(hourDiv);
            }

            let dailyTasks = [];
            goals.forEach(g => {
                g.tasks.forEach(t => {
                    if(t.date === dateStr) dailyTasks.push({...t, goalId: g.id, goalTitle: g.title});
                });
            });

            if(dailyTasks.length === 0) document.getElementById('daily-empty-msg').classList.remove('hidden');
            else document.getElementById('daily-empty-msg').classList.add('hidden');

            dailyTasks.sort((a, b) => {
                if(!a.startTime) return 1;
                if(!b.startTime) return -1;
                return a.startTime.localeCompare(b.startTime);
            });

            dailyTasks.forEach(task => {
                const div = document.createElement('div');
                div.className = `flex flex-col sm:flex-row items-center gap-2 p-3 rounded border shadow-sm task-item ${task.completed ? 'bg-gray-100' : 'bg-white'}`;
                const borderClass = task.priority === 'high' ? 'border-l-red-500' : (task.priority === 'low' ? 'border-l-gray-400' : 'border-l-blue-500');
                div.classList.add('border-l-4', borderClass);

                div.innerHTML = `
                    <div class="flex-1 w-full">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" onchange="toggleTask(${task.goalId}, ${task.id})" ${task.completed ? 'checked' : ''} class="w-5 h-5 accent-indigo-600">
                            <input type="text" value="${task.title}" onchange="updateTaskDetails(${task.goalId}, ${task.id}, 'title', this.value)" class="font-bold text-gray-800 w-full border-b border-transparent hover:border-gray-300 focus:outline-none ${task.completed ? 'line-through opacity-50':''}">
                        </div>
                        <div class="text-xs text-gray-500 mt-1 ml-7">${task.goalTitle}</div>
                    </div>
                    <div class="flex items-center gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                        <input type="time" value="${task.startTime}" onchange="updateTaskDetails(${task.goalId}, ${task.id}, 'startTime', this.value)" class="text-xs p-1 border rounded shadow-sm">
                        <div class="flex items-center gap-1">
                            <input type="number" value="${task.duration}" onchange="updateTaskDetails(${task.goalId}, ${task.id}, 'duration', this.value)" class="w-12 text-xs p-1 border rounded shadow-sm">
                            <span class="text-xs text-gray-500">åˆ†</span>
                        </div>
                        <button onclick="deleteTask(${task.goalId}, ${task.id})" class="text-gray-400 hover:text-red-500 px-2 py-1 delete-btn" title="å‰Šé™¤"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                `;
                container.appendChild(div);

                if(task.startTime && !task.completed) {
                    const [h, m] = task.startTime.split(':').map(Number);
                    const startMinutes = (h * 60) + m;
                    const startOffset = startMinutes - (6 * 60); 
                    if(startOffset >= 0) {
                        const pxPerMin = 25 / 60; 
                        const top = startOffset * pxPerMin;
                        const height = task.duration * pxPerMin;
                        const block = document.createElement('div');
                        block.className = 'time-block truncate px-1';
                        if(task.priority === 'high') block.classList.add('bg-red-500');
                        else if(task.priority === 'low') block.classList.add('bg-gray-400');
                        else block.classList.add('bg-blue-500');
                        block.style.top = `${top + 10}px`; 
                        block.style.height = `${Math.max(18, height)}px`; 
                        block.innerHTML = `<span class="font-bold">${task.startTime}</span> ${task.title}`;
                        timeline.appendChild(block);
                    }
                }
            });
        }

        // --- ææ¡ˆæ©Ÿèƒ½ ---
        function openSuggest(goalId, goalTitle) {
            currentGoalId = goalId;
            const list = document.getElementById('suggest-list');
            list.innerHTML = '';
            let key = 'default';
            for(let k in SUGGESTIONS) if(goalTitle.includes(k)) key = k;
            SUGGESTIONS[key].forEach((text, i) => {
                list.innerHTML += `
                    <div class="flex items-center p-2 border-b hover:bg-gray-50">
                        <input type="checkbox" id="sug-${i}" value="${text}" checked class="mr-2 accent-indigo-600">
                        <label for="sug-${i}" class="text-sm cursor-pointer flex-1">${text}</label>
                    </div>`;
            });
            document.getElementById('modal-suggest').classList.remove('hidden');
        }

        function importSuggestedTasks() {
            const inputs = document.querySelectorAll('#suggest-list input:checked');
            if(inputs.length === 0) return;
            const goal = goals.find(g => g.id === currentGoalId);
            const today = new Date();
            inputs.forEach((input, i) => {
                const d = new Date(today);
                d.setDate(today.getDate() + 1 + Math.floor(i/2));
                const dStr = d.toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'}).replaceAll('/','-');
                goal.tasks.push({ id: Date.now() + i, title: input.value, date: dStr, priority: 'mid', startTime: '', duration: 30, completed: false });
            });
            saveData();
            document.getElementById('modal-suggest').classList.add('hidden');
        }

        // --- æ‰‹å‹•LINEå…±æœ‰ & ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ ---
        function sendScheduleToLine() {
            const todayStr = new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'}).replaceAll('/','-');
            let todays = [];
            goals.forEach(g => g.tasks.forEach(t => { if(t.date === todayStr && !t.completed) todays.push({...t, goalTitle: g.title}); }));
            todays.sort((a,b) => (a.startTime||'99:99').localeCompare(b.startTime||'99:99'));

            if(todays.length === 0 && notToDos.length === 0) { alert("ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚‚ã€ã‚„ã‚‰ãªã„ã“ã¨ãƒªã‚¹ãƒˆã‚‚ã‚ã‚Šã¾ã›ã‚“ï¼"); return; }
            
            let message = `ğŸ“… ${todayStr} ã®äºˆå®š\n\n`;
            if(todays.length > 0) {
                todays.forEach(t => {
                    const time = t.startTime ? `${t.startTime} ` : 'æ™‚é–“æœªå®š ';
                    message += `ãƒ»${time}${t.title}\n`;
                });
            } else {
                message += `ï¼ˆã‚¿ã‚¹ã‚¯ãªã—ï¼‰\n`;
            }
            
            message += `\nâ›” ã‚„ã‚‰ãªã„ã“ã¨ãƒã‚§ãƒƒã‚¯\n`;
            notToDos.forEach(n => {
                const done = n.lastCheckedDate === todayStr ? 'âœ… é”æˆ!' : 'â¬œ æœªé”æˆ';
                message += `${done} ${n.title}\n`;
            });
            message += `\n#KAKUGO_Planner`;
            
            // LINEèµ·å‹•ç”¨URL
            const url = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
            else Notification.requestPermission().then(p => { if (p === "granted") new Notification("é€šçŸ¥è¨­å®šå®Œäº†"); });
        }

        function checkNotifications() {
            if (Notification.permission !== "granted") return;
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const todayStr = now.toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'}).replaceAll('/','-');
            goals.forEach(g => {
                g.tasks.forEach(t => {
                    if(t.date === todayStr && t.startTime === currentTime && !t.completed) {
                        new Notification(`æ™‚é–“ã§ã™: ${t.title}`, { body: `${t.startTime} - ${g.title}` });
                    }
                });
            });
            setTimeout(checkNotifications, 60000);
        }

        // --- æç”»å…¨èˆ¬ ---
        function renderAll() {
            // 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ç”¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°
            const quickSelect = document.getElementById('quick-task-goal');
            quickSelect.innerHTML = '';
            goals.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id;
                opt.innerText = g.title;
                quickSelect.appendChild(opt);
            });

            // 2. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
            const dashList = document.getElementById('today-task-list');
            dashList.innerHTML = '';
            const todayStr = new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'}).replaceAll('/','-');
            
            let todays = [];
            goals.forEach(g => g.tasks.forEach(t => { if(t.date === todayStr) todays.push({...t, goalId: g.id, goalTitle: g.title}); }));
            
            todays.sort((a,b) => {
                if(a.completed !== b.completed) return a.completed - b.completed;
                const timeA = a.startTime || '99:99';
                const timeB = b.startTime || '99:99';
                if(timeA !== timeB) return timeA.localeCompare(timeB);
                const prioScore = {high:3, mid:2, low:1};
                return prioScore[b.priority] - prioScore[a.priority];
            });

            if(todays.length === 0) dashList.innerHTML = '<div class="text-gray-400 text-center py-10 bg-gray-50 rounded border border-dashed">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';

            todays.forEach(t => {
                const div = document.createElement('div');
                let prioClass = t.priority === 'high' ? 'prio-high' : (t.priority === 'low' ? 'prio-low' : 'prio-mid');
                if(t.completed) prioClass = 'bg-gray-100 border-l-4 border-gray-300'; 

                div.className = `flex items-center p-3 rounded shadow-sm transition task-item ${prioClass}`;
                div.innerHTML = `
                    <button onclick="toggleTask(${t.goalId}, ${t.id})" class="mr-3 w-6 h-6 rounded-full border border-gray-400 bg-white flex justify-center items-center hover:bg-indigo-50 transition">
                        ${t.completed ? '<i class="fa-solid fa-check text-indigo-500"></i>' : '<span class="w-full h-full rounded-full"></span>'}
                    </button>
                    <div class="flex-1 cursor-pointer" onclick="openDailyDetail(new Date())">
                        <div class="font-bold text-gray-800 ${t.completed?'line-through opacity-50':''}">${t.title}</div>
                        <div class="text-xs text-gray-500 flex gap-3 mt-1">
                            <span class="bg-white px-1 rounded border border-gray-200"><i class="fa-solid fa-folder-open text-indigo-400"></i> ${t.goalTitle}</span>
                            ${t.startTime ? `<span class="font-bold text-indigo-600"><i class="fa-regular fa-clock"></i> ${t.startTime} (${t.duration}åˆ†)</span>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteTask(${t.goalId}, ${t.id})" class="text-gray-400 hover:text-red-500 px-3 py-2 delete-btn" title="å‰Šé™¤"><i class="fa-solid fa-trash-can"></i></button>
                `;
                dashList.appendChild(div);
            });

            // 3. Planning
            const planContainer = document.getElementById('goals-container');
            planContainer.innerHTML = '';
            goals.forEach(g => {
                let tasksHtml = '';
                const sortedTasks = [...g.tasks].sort((a,b) => a.completed - b.completed || new Date(a.date) - new Date(b.date));
                sortedTasks.forEach(t => {
                    let color = t.priority === 'high' ? 'text-red-500' : (t.priority === 'low' ? 'text-gray-400' : 'text-blue-500');
                    tasksHtml += `
                        <div class="flex justify-between items-center p-2 border-b text-sm hover:bg-gray-50 group">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-circle text-[6px] ${color}"></i>
                                <span class="${t.completed?'line-through text-gray-300':''}">${t.title}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="text-xs text-gray-400">${t.date.slice(5)}</div>
                                <button onclick="deleteTask(${g.id}, ${t.id})" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>`;
                });

                const div = document.createElement('div');
                div.className = 'bg-white rounded shadow p-4 border-t-4 border-indigo-500';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg text-gray-700">${g.title}</h3>
                        <div class="flex gap-2">
                            <button onclick="openSuggest(${g.id}, '${g.title}')" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 transition"><i class="fa-solid fa-wand-magic-sparkles"></i> ææ¡ˆ</button>
                            <button onclick="deleteGoal(${g.id})" class="text-xs text-gray-400 hover:text-red-500 border border-gray-300 px-2 py-1 rounded hover:bg-red-50 transition">å‰Šé™¤</button>
                        </div>
                    </div>
                    <div class="flex gap-1 mb-2 bg-gray-100 p-2 rounded">
                        <input id="title-${g.id}" type="text" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯" class="flex-1 border p-1 rounded text-sm focus:ring-2 focus:ring-indigo-300 outline-none">
                        <input id="date-${g.id}" type="date" value="${todayStr}" class="border p-1 rounded text-sm text-gray-600">
                        <select id="prio-${g.id}" class="border p-1 rounded text-sm text-gray-600">
                            <option value="high">é«˜</option>
                            <option value="mid" selected>ä¸­</option>
                            <option value="low">ä½</option>
                        </select>
                        <button onclick="addTask(${g.id})" class="bg-indigo-600 text-white px-3 rounded text-sm hover:bg-indigo-700 transition"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="max-h-40 overflow-y-auto border rounded bg-white">${tasksHtml}</div>
                `;
                planContainer.appendChild(div);
            });
        }

        // Calendar
        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('calendar-month-display').innerText = `${year}å¹´ ${month+1}æœˆ`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month+1, 0);
            const container = document.getElementById('calendar-cells');
            container.innerHTML = '';
            
            for(let i=0; i<firstDay.getDay(); i++) container.innerHTML += '<div class="calendar-day bg-gray-50 border-gray-100"></div>';
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            for(let d=1; d<=lastDay.getDate(); d++) {
                const dDate = new Date(year, month, d);
                const dStr = dDate.toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'}).replaceAll('/','-');
                
                let tasks = [];
                goals.forEach(g => g.tasks.forEach(t => { if(t.date === dStr) tasks.push(t); }));
                tasks.sort((a,b) => a.completed - b.completed);

                let dots = tasks.slice(0,4).map(t => {
                    let bg = t.priority==='high' ? 'bg-red-500' : (t.priority==='low' ? 'bg-gray-400' : 'bg-blue-500');
                    if(t.completed) bg = 'bg-gray-200 text-gray-400 line-through'; else bg += ' text-white';
                    return `<div class="truncate text-[10px] rounded px-1 mb-0.5 ${bg}">${t.title}</div>`;
                }).join('');
                if(tasks.length > 4) dots += `<div class="text-[9px] text-gray-400 text-center">+ä»–${tasks.length-4}ä»¶</div>`;
                const isToday = isCurrentMonth && d === today.getDate();
                const cell = document.createElement('div');
                cell.className = `calendar-day cursor-pointer transition flex flex-col ${isToday ? 'today' : ''}`;
                cell.onclick = () => openDailyDetail(dDate); 
                cell.innerHTML = `
                    <div class="text-right font-bold text-xs mb-1 ${isToday?'text-indigo-600':''}">${d}</div>
                    <div class="flex-1 overflow-hidden">${dots}</div>
                    ${tasks.length === 0 ? '<div class="absolute inset-0 flex justify-center items-center opacity-0 hover:opacity-100 text-indigo-300 text-2xl">+</div>' : ''}
                `;
                container.appendChild(cell);
            }
        }
    </script>
</body>
</html>